<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimiseur de Vente de Garri - Lom√©</title>
    <!-- Chosen Palette: Warm Earth -->
    <!-- Application Structure Plan: L'application est structur√©e en quatre sections th√©matiques accessibles via une barre de navigation fixe : Accueil (Tableau de bord), Finances, Strat√©gie et March√©. Cette structure permet √† l'utilisateur de naviguer logiquement, en commen√ßant par un aper√ßu global et un calculateur interactif (Accueil), en examinant les co√ªts (Finances), en explorant les plans de vente (Strat√©gie), et enfin en consultant les donn√©es du march√© (March√©). Les fonctionnalit√©s interactives cl√©s incluent le calculateur de profit global et les deux nouveaux appels √† l'IA de Gemini (via le proxy) pour g√©n√©rer une strat√©gie de vente personnalis√©e et obtenir des informations sur le march√© en temps r√©el, rendant l'outil √† la fois un planificateur et un instrument d'analyse dynamique. -->
    <!-- Visualization & Content Choices: 
        1.  Aper√ßu (Accueil) -> Informer -> Cartes de statistiques (KPI) -> Non interactif -> Affiche les chiffres cl√©s (Investissement, Inventaire).
        2.  Calculateur (Accueil) -> Explorer -> Curseurs et champs de saisie -> L'utilisateur modifie le prix/co√ªt, le JS recalcule le revenu/profit -> Permet une simulation financi√®re instantan√©e.
        3.  R√©partition des co√ªts (Finances) -> Comparer -> Graphique en anneau (Chart.js) -> Mise √† jour dynamique lorsque les co√ªts changent -> Montre visuellement la part de chaque co√ªt.
        4.  Strat√©gie de vente (Strat√©gie) -> Guider -> Cartes statiques + Appel IA (Proxy) -> Clic sur "G√©n√©rer" -> L'IA fournit un plan en 3 phases bas√© sur les donn√©es de l'utilisateur.
        5.  Tendances du march√© (March√©) -> Analyser -> Graphique lin√©aire (Chart.js) -> Non interactif -> Montre les prix historiques et projet√©s.
        6.  Infos March√© (March√©) -> Informer -> Appel IA avec grounding (Proxy) -> Clic sur "Obtenir" -> L'IA (via proxy) r√©sume les tendances actuelles du march√©.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FBFBFB;
            color: #333;
        }
        .container { max-width: 1100px; }
        .primary-btn {
            background-color: #8C6A5D;
            color: #FFFFFF;
            transition: background-color 0.3s ease;
        }
        .primary-btn:hover { background-color: #73564B; }
        .stat-card {
            background-color: #FFFFFF;
            border: 1px solid #EFEAE6;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 40vh;
        }
        .nav-link {
            position: relative;
            padding-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 3px;
            background-color: #8C6A5D;
            transition: width 0.3s ease;
        }
        .nav-link:hover::after, .nav-link.active::after {
            width: 100%;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.3s ease;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 6px solid #EFEAE6;
            border-bottom-color: #8C6A5D;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
    </div>

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200/50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0 flex items-center">
                    <span class="text-xl font-bold text-[#73564B]">üåæ Optimiseur Garri</span>
                </div>
                <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                    <a href="#dashboard" class="nav-link active">Accueil</a>
                    <a href="#financials" class="nav-link">Finances</a>
                    <a href="#strategy" class="nav-link">Strat√©gie</a>
                    <a href="#market" class="nav-link">March√©</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
        
        <!-- Section 1: Tableau de bord -->
        <section id="dashboard" class="mb-16">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-4 text-[#73564B]">Tableau de Bord Op√©rationnel</h1>
            <p class="text-center text-lg text-gray-600 max-w-3xl mx-auto mb-10">Un plan interactif pour maximiser le profit de la vente de garri √† Lom√©. Ce tableau de bord offre une vue d'ensemble de votre projet, avec des m√©triques cl√©s et un calculateur de profit dynamique.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="stat-card p-6 rounded-xl shadow-sm text-center">
                    <h3 class="text-sm font-medium text-gray-500 uppercase">Investissement Initial Total</h3>
                    <p class="mt-1 text-3xl font-semibold text-[#8C6A5D]" id="totalInvestmentDisplay">1 519 000 CFA</p>
                </div>
                <div class="stat-card p-6 rounded-xl shadow-sm">
                    <label for="inventoryInput" class="block text-sm font-medium text-gray-500 uppercase text-center">Inventaire Total (Sacs)</label>
                    <input type="number" id="inventoryInput" value="178" class="mt-1 text-3xl font-semibold text-[#8C6A5D] w-full text-center bg-transparent border-none focus:ring-0 p-0">
                    <p class="text-xs text-gray-500 text-center">(50kg par sac)</p>
                </div>
                <div class="stat-card p-6 rounded-xl shadow-sm text-center">
                    <h3 class="text-sm font-medium text-gray-500 uppercase">Fen√™tre de Vente Projet√©e</h3>
                    <p class="mt-1 text-3xl font-semibold text-[#8C6A5D]">Janv - Mars 2026</p>
                </div>
            </div>
            
            <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200/80">
                <div class="flex justify-center items-center mb-2 relative">
                     <h2 class="text-2xl font-bold text-center text-[#73564B]">Calculateur de Profit Interactif</h2>
                     <button id="resetButton" class="absolute right-0 top-0 primary-btn text-xs font-bold py-1 px-3 rounded-full flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3L22 2.5M22 12.5a10 10 0 0 1-18.8 4.3L2 21.5"/></svg>
                        R√©initialiser
                     </button>
                </div>
                <p class="text-center text-gray-600 mb-6">Ajustez le prix de vente, l'inventaire ou les co√ªts pour voir instantan√©ment vos revenus et profits potentiels.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div class="space-y-4">
                        <label for="sellingPrice" class="block text-sm font-medium text-gray-700">Prix de Vente Moyen par Sac de 50kg (CFA)</label>
                        <input type="range" id="sellingPrice" min="12000" max="25000" value="16500" step="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" style="accent-color: #8C6A5D;">
                        <p class="text-center text-2xl font-bold text-[#8C6A5D]" id="sellingPriceValue">16 500 CFA</p>
                    </div>
                    <div class="space-y-4 text-center md:text-left">
                        <div class="grid grid-cols-3 gap-4">
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-500 uppercase">Revenu Projet√©</h4>
                                <p class="text-2xl font-semibold text-[#73564B]" id="projectedRevenue">2 937 000</p>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-500 uppercase">B√©n√©fice Brut</h4>
                                <p class="text-2xl font-semibold text-green-700" id="grossProfit">1 418 000</p>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-500 uppercase">Marge B√©n√©ficiaire</h4>
                                <p class="text-2xl font-semibold text-green-700" id="profitMargin">93,35%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Finances -->
        <section id="financials" class="mb-16 pt-16">
            <h2 class="text-3xl md:text-4xl font-bold text-center mb-4 text-[#73564B]">D√©tail des Finances</h2>
            <p class="text-center text-lg text-gray-600 max-w-3xl mx-auto mb-10">Un aper√ßu d√©taill√© de vos co√ªts projet√©s. Comprendre ces chiffres est la premi√®re √©tape vers une entreprise rentable.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 items-center">
                <div>
                    <h3 class="text-xl font-bold mb-4 text-[#73564B]">Structure des Co√ªts</h3>
                    <ul class="space-y-3">
                        <li class="flex justify-between items-center p-3 bg-white rounded-lg border">
                            <label for="costPerBagInput" class="font-medium text-gray-700">Co√ªt par Sac</label>
                            <input type="number" id="costPerBagInput" class="font-semibold text-gray-900 text-right border-none bg-transparent focus:ring-0 w-36" value="8000">
                        </li>
                        <li class="flex justify-between items-center p-3 bg-white rounded-lg border">
                            <span class="font-medium text-gray-700">Co√ªt d'Achat du Garri</span>
                             <span id="purchaseCostDisplay" class="font-semibold text-gray-900 text-right w-36 pr-3">1 424 000</span>
                        </li>
                        <li class="flex justify-between items-center p-3 bg-white rounded-lg border">
                            <label for="transportCostInput" class="font-medium text-gray-700">Transport vers Lom√©</label>
                            <input type="number" id="transportCostInput" class="font-semibold text-gray-900 text-right border-none bg-transparent focus:ring-0 w-36" value="75000">
                        </li>
                        <li class="flex justify-between items-center p-3 bg-white rounded-lg border">
                            <label for="storageCostInput" class="font-medium text-gray-700">Stockage & Manutention</label>
                            <input type="number" id="storageCostInput" class="font-semibold text-gray-900 text-right border-none bg-transparent focus:ring-0 w-36" value="20000">
                        </li>
                        <li class="flex justify-between items-center p-4 bg-gray-100 rounded-lg border border-gray-300 mt-2">
                            <span class="font-bold text-gray-800">Co√ªt Total Estim√©</span>
                            <span class="font-bold text-lg text-[#8C6A5D]" id="totalCostDisplay">1 519 000 CFA</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <div class="chart-container">
                        <canvas id="costBreakdownChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Strat√©gie de Vente -->
        <section id="strategy" class="mb-16 pt-16">
            <div class="flex flex-col items-center mb-10">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-4 text-[#73564B]">Strat√©gie de Vente Optimale</h2>
                <p class="text-center text-lg text-gray-600 max-w-3xl mx-auto mb-6">Cette strat√©gie vise √† maximiser les revenus en programmant les ventes en fonction des augmentations de prix pr√©vues. Utilisez le bouton ci-dessous pour g√©n√©rer une strat√©gie personnalis√©e.</p>
                <button id="generateStrategyBtn" class="primary-btn font-semibold py-2 px-6 rounded-lg flex items-center justify-center space-x-2 transition-transform transform hover:scale-105">
                    <span class="text-lg">‚ú®</span>
                    <span>G√©n√©rer une Strat√©gie IA</span>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200/80 transform hover:-translate-y-2 transition-transform duration-300">
                    <div class="text-3xl mb-4">üóìÔ∏è</div>
                    <h3 class="text-xl font-bold mb-2 text-[#8C6A5D]">Phase 1 : Janvier</h3>
                    <p class="font-semibold text-lg mb-2" id="phase1Title">Vendre 30% du Stock</p>
                    <p class="text-gray-600" id="phase1Bags">(~53 sacs)</p>
                    <p class="text-sm text-gray-500 mt-4" id="phase1Text">Entrez sur le march√© alors que la demande post-vacances se stabilise. Cette vente initiale fournit des liquidit√©s pr√©coces.</p>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200/80 transform hover:-translate-y-2 transition-transform duration-300">
                    <div class="text-3xl mb-4">üìà</div>
                    <h3 class="text-xl font-bold mb-2 text-[#8C6A5D]">Phase 2 : F√©vrier</h3>
                    <p class="font-semibold text-lg mb-2" id="phase2Title">Vendre 40% du Stock</p>
                    <p class="text-gray-600" id="phase2Bags">(~71 sacs)</p>
                    <p class="text-sm text-gray-500 mt-4" id="phase2Text">Profitez de la hausse des prix alors que l'offre de la r√©colte principale diminue. P√©riode de demande de pointe projet√©e.</p>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200/80 transform hover:-translate-y-2 transition-transform duration-300">
                    <div class="text-3xl mb-4">üí∞</div>
                    <h3 class="text-xl font-bold mb-2 text-[#8C6A5D]">Phase 3 : Mars</h3>
                    <p class="font-semibold text-lg mb-2" id="phase3Title">Vendre les 30% Finaux</p>
                    <p class="text-gray-600" id="phase3Bags">(~54 sacs)</p>
                    <p class="text-sm text-gray-500 mt-4" id="phase3Text">Vendez le stock restant aux prix projet√©s les plus √©lev√©s avant le d√©but de la nouvelle saison des semailles.</p>
                </div>
            </div>
        </section>

        <!-- Section 4: Donn√©es du March√© -->
        <section id="market" class="pt-16">
            <div class="flex flex-col items-center mb-10">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-4 text-[#73564B]">Analyse du March√© du Garri √† Lom√©</h2>
                <p class="text-center text-lg text-gray-600 max-w-3xl mx-auto mb-6">Les donn√©es historiques montrent un sch√©ma cyclique. Pour les informations les plus r√©centes, utilisez le bouton ci-dessous pour obtenir des informations sur le march√© en temps r√©el.</p>
                <button id="getInsightsBtn" class="primary-btn font-semibold py-2 px-6 rounded-lg flex items-center justify-center space-x-2 transition-transform transform hover:scale-105">
                    <span class="text-lg">‚ú®</span>
                    <span>Obtenir les Derni√®res Infos March√©</span>
                </button>
            </div>
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200/80">
                <h3 class="text-xl font-bold text-center mb-4 text-[#73564B]">Prix Historiques & Projet√©s (par sac de 50kg)</h3>
                <div class="chart-container">
                    <canvas id="marketPriceChart"></canvas>
                </div>

                <div id="marketInsightsWrapper" class="mt-8 pt-6 border-t border-gray-200 hidden">
                    <h3 class="text-2xl font-bold text-center mb-4 text-[#73564B]">‚ú® Aper√ßus du March√© par IA</h3>
                    <div id="marketInsights" class="prose prose-sm max-w-none text-gray-700 bg-gray-50 p-4 rounded-lg"></div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-white mt-16 border-t">
        <div class="container mx-auto py-6 px-4 text-center text-gray-500 text-sm">
            <p>&copy; 2025 Optimiseur de Vente de Garri. Outil de planification interactif.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const DEFAULT_DATA = {
                inventory: 178,
                sellingPrice: 16500,
                costPerBag: 8000,
                costs: {
                    transport: 75000,
                    storage: 20000,
                },
                marketPrices: {
                    labels: ['Janv', 'F√©vr', 'Mars', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sept', 'Oct', 'Nov', 'D√©c', 'Janv \'26', 'F√©vr \'26', 'Mars \'26'],
                    historical: [13000, 13500, 14000, 15000, 15500, 15000, 14500, 14000, 13000, 12000, 12500, 13000],
                    projected: [null, null, null, null, null, null, null, null, null, null, null, null, 15500, 16500, 17500]
                }
            };

            let costBreakdownChart;
            
            const formatCFA = (value) => new Intl.NumberFormat('fr-FR').format(value) + ' CFA';
            const formatNumber = (value) => new Intl.NumberFormat('fr-FR').format(value);
            const formatPercent = (value) => isFinite(value) ? value.toFixed(2) + '%' : '0,00%';

            const sellingPriceSlider = document.getElementById('sellingPrice');
            const sellingPriceValue = document.getElementById('sellingPriceValue');
            const projectedRevenue = document.getElementById('projectedRevenue');
            const grossProfit = document.getElementById('grossProfit');
            const profitMargin = document.getElementById('profitMargin');

            const inventoryInput = document.getElementById('inventoryInput');
            const costPerBagInput = document.getElementById('costPerBagInput');
            const transportCostInput = document.getElementById('transportCostInput');
            const storageCostInput = document.getElementById('storageCostInput');

            const purchaseCostDisplay = document.getElementById('purchaseCostDisplay');
            const totalInvestmentDisplay = document.getElementById('totalInvestmentDisplay');
            const totalCostDisplay = document.getElementById('totalCostDisplay');
            const phase1Bags = document.getElementById('phase1Bags');
            const phase2Bags = document.getElementById('phase2Bags');
            const phase3Bags = document.getElementById('phase3Bags');
            const phase1Title = document.getElementById('phase1Title');
            const phase2Title = document.getElementById('phase2Title');
            const phase3Title = document.getElementById('phase3Title');
            const phase1Text = document.getElementById('phase1Text');
            const phase2Text = document.getElementById('phase2Text');
            const phase3Text = document.getElementById('phase3Text');
            
            const generateStrategyBtn = document.getElementById('generateStrategyBtn');
            const getInsightsBtn = document.getElementById('getInsightsBtn');
            const marketInsightsWrapper = document.getElementById('marketInsightsWrapper');
            const marketInsights = document.getElementById('marketInsights');
            
            const loadingOverlay = document.getElementById('loading-overlay');
            
            const resetButton = document.getElementById('resetButton');
            
            const CLOUD_RUN_FUNCTION_URL = 'https://github-pages-gemini-proxy-238410973313.us-central1.run.app';

            async function fetchWithTimeout(url, options, timeout = 30000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);

                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(id);
                    return response;
                } catch (error) {
                    clearTimeout(id);
                    if (error.name === 'AbortError') {
                        throw new Error('La requ√™te a expir√© (timeout).');
                    }
                    throw error;
                }
            }

            async function callCloudRunProxy(prompt, systemInstruction, grounded = false) {
                if (!CLOUD_RUN_FUNCTION_URL.startsWith('https://')) {
                   throw new Error("L'URL de la fonction Cloud Run n'est pas configur√©e. Veuillez mettre √† jour la constante CLOUD_RUN_FUNCTION_URL.");
                }
               
                const payload = {
                   prompt: prompt,
                   systemInstruction: systemInstruction,
                   grounded: grounded
                };

                const response = await fetchWithTimeout(CLOUD_RUN_FUNCTION_URL, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(payload)
                }, 30000);

                if (response.ok) {
                      const result = await response.json();
                      if (result && result.response) {
                          return result.response;
                      } else {
                          throw new Error('Structure de r√©ponse invalide de la fonction proxy.');
                      }
                } else {
                      const errorBody = await response.json();
                      console.error("Erreur du proxy:", errorBody);
                      throw new Error(`La fonction proxy a retourn√© une erreur: ${response.status} ${errorBody.error || ''}`);
                }
            }

            function showLoading(show) {
                console.log('showLoading starting');
                if (show) {
                    console.log('showLoading true', show);
                    loadingOverlay.classList.remove('hidden');
                    loadingOverlay.style.opacity = '1';
                } else {
                    console.log('showLoading false', show);
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.classList.add('hidden');
                    }, 300);
                }
            }

            async function handleGenerateStrategy() {
                showLoading(true);
                console.log('handleGenerateStrategy show true');
                try {
                const inventory = parseInt(inventoryInput.value) || 0;
                const totalCost = parseInt(totalCostDisplay.textContent.replace(/[^0-9]/g, '')) || 0;

                const systemPrompt = "Agissez en tant qu'expert du commerce des mati√®res premi√®res √† Lom√©, Togo, sp√©cialis√© dans les produits agricoles comme le garri. L'entrep√¥t de l'utilisateur est √† Totsi, Lom√©.";
                const userPrompt = `J'ai ${inventory} sacs de garri (50kg chacun) avec un co√ªt total de ${totalCost} CFA. Ma fen√™tre de vente est de janvier √† mars. Les prix historiques augmentent pendant cette p√©riode.
                
                G√©n√©rez une strat√©gie de vente en gros en 3 phases (Janvier, F√©vrier, Mars) pour maximiser le profit.
                
                Retournez *uniquement* un objet JSON suivant ce sch√©ma exact:
                {
                  "phase1": { "percent": number, "rationale": "string" },
                  "phase2": { "percent": number, "rationale": "string" },
                  "phase3": { "percent": number, "rationale": "string" }
                }
                
                Les pourcentages doivent totaliser 100. La justification doit √™tre une br√®ve explication en fran√ßais.`;
console.log("Calling proxy‚Ä¶", CLOUD_RUN_FUNCTION_URL);

                
                    const jsonString = await callCloudRunProxy(userPrompt, systemPrompt, false);
                    const strategy = JSON.parse(jsonString);
                    
                    const p1Bags = Math.round(inventory * (strategy.phase1.percent / 100));
                    const p2Bags = Math.round(inventory * (strategy.phase2.percent / 100));
                    const p3Bags = inventory - p1Bags - p2Bags; 

                    phase1Title.textContent = `Vendre ${strategy.phase1.percent}% du Stock`;
                    phase1Bags.textContent = `(~${p1Bags} sacs)`;
                    phase1Text.textContent = strategy.phase1.rationale;

                    phase2Title.textContent = `Vendre ${strategy.phase2.percent}% du Stock`;
                    phase2Bags.textContent = `(~${p2Bags} sacs)`;
                    phase2Text.textContent = strategy.phase2.rationale;

                    phase3Title.textContent = `Vendre ${strategy.phase3.percent}% du Stock`;
                    phase3Bags.textContent = `(~${p3Bags} sacs)`;
                    phase3Text.textContent = strategy.phase3.rationale;

                } catch (error) {
                    console.error('Erreur lors de la g√©n√©ration de la strat√©gie:', error);
                    alert("Une erreur est survenue lors de la g√©n√©ration de la strat√©gie. V√©rifiez la console.");
                } finally {
                    showLoading(false);
                }
            }
            
            async function handleGetInsights() {
                showLoading(true);
                marketInsightsWrapper.classList.add('hidden');
                
                const systemPrompt = "Agissez en tant qu'analyste de march√© pour Lom√©, Togo. Fournissez un r√©sum√© concis en fran√ßais, sous forme de puces, des derni√®res tendances, des facteurs de prix et des perspectives pour le march√© du garri √† Lom√© pour les 3 prochains mois. Concentrez-vous sur les informations pertinentes pour un vendeur en gros.";
                const userPrompt = "Quelles sont les derni√®res nouvelles et tendances des prix pour le garri et le manioc √† Lom√©, Togo pour d√©but 2026 ? Incluez les facteurs tels que la m√©t√©o, le transport et la demande saisonni√®re.";
                
                try {
                    console.log("Calling proxy‚Ä¶", CLOUD_RUN_FUNCTION_URL);

                    const textResponse = await callCloudRunProxy(userPrompt, systemPrompt, true);
                    const text = textResponse.replace(/\n/g, '<br>');
                    marketInsights.innerHTML = text;
                    marketInsightsWrapper.classList.remove('hidden');

                } catch (error) {
                    console.error('Erreur lors de la r√©cup√©ration des infos march√©:', error);
                                        alert("Une erreur est survenue lors de la g√©n√©ration de la strat√©gie. V√©rifiez la console.");

                } finally {
                    showLoading(false);
                }
            }

            function updateAllCalculations() {
                const inventory = parseInt(inventoryInput.value) || 0;
                const costPerBag = parseInt(costPerBagInput.value) || 0;
                const transportCost = parseInt(transportCostInput.value) || 0;
                const storageCost = parseInt(storageCostInput.value) || 0;
                const sellingPrice = parseInt(sellingPriceSlider.value);

                const purchaseCost = inventory * costPerBag;
                const totalCost = purchaseCost + transportCost + storageCost;
                
                const revenue = sellingPrice * inventory;
                const profit = revenue - totalCost;
                const margin = totalCost > 0 ? (profit / totalCost) * 100 : 0;
                
                sellingPriceValue.textContent = formatCFA(sellingPrice);
                projectedRevenue.textContent = formatNumber(revenue);
                grossProfit.textContent = formatNumber(profit);
                profitMargin.textContent = formatPercent(margin);
                
                purchaseCostDisplay.textContent = formatNumber(purchaseCost);
                totalInvestmentDisplay.textContent = formatCFA(totalCost);
                totalCostDisplay.textContent = formatCFA(totalCost);

                const p1Bags = Math.round(inventory * 0.3);
                const p2Bags = Math.round(inventory * 0.4);
                const p3Bags = inventory - p1Bags - p2Bags;
                
                phase1Title.textContent = "Vendre 30% du Stock";
                phase1Bags.textContent = `(~${p1Bags} sacs)`;
                phase1Text.textContent = "Entrez sur le march√© alors que la demande post-vacances se stabilise. Cette vente initiale fournit des liquidit√©s pr√©coces.";

                phase2Title.textContent = "Vendre 40% du Stock";
                phase2Bags.textContent = `(~${p2Bags} sacs)`;
                phase2Text.textContent = "Profitez de la hausse des prix alors que l'offre de la r√©colte principale diminue. P√©riode de demande de pointe projet√©e.";
                
                phase3Title.textContent = `Vendre les 30% Finaux`;
                phase3Bags.textContent = `(~${p3Bags} sacs)`;
                phase3Text.textContent = "Vendez le stock restant aux prix projet√©s les plus √©lev√©s avant le d√©but de la nouvelle saison des semailles.";
                
                costBreakdownChart.data.datasets[0].data = [purchaseCost, transportCost, storageCost];
                costBreakdownChart.update();
            }

            function resetAll() {
                inventoryInput.value = DEFAULT_DATA.inventory;
                costPerBagInput.value = DEFAULT_DATA.costPerBag;
                transportCostInput.value = DEFAULT_DATA.costs.transport;
                storageCostInput.value = DEFAULT_DATA.costs.storage;
                sellingPriceSlider.value = DEFAULT_DATA.sellingPrice;
                updateAllCalculations();
            }

            const allInputs = [inventoryInput, costPerBagInput, transportCostInput, storageCostInput, sellingPriceSlider];
            allInputs.forEach(input => input.addEventListener('input', updateAllCalculations));
            resetButton.addEventListener('click', resetAll);
            generateStrategyBtn.addEventListener('click', handleGenerateStrategy);
            getInsightsBtn.addEventListener('click', handleGetInsights);

            Chart.defaults.font.family = 'Inter';

            const costBreakdownCtx = document.getElementById('costBreakdownChart').getContext('2d');
            costBreakdownChart = new Chart(costBreakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Achat Garri', 'Transport', 'Stockage'],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#8C6A5D', '#BFA69A', '#D9C8BF'],
                        borderColor: '#FFFFFF',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                boxWidth: 12,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatCFA(context.raw)}`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });

            const marketPriceCtx = document.getElementById('marketPriceChart').getContext('2d');
            new Chart(marketPriceCtx, {
                type: 'line',
                data: {
                    labels: DEFAULT_DATA.marketPrices.labels,
                    datasets: [
                        {
                            label: 'Prix Historique',
                            data: DEFAULT_DATA.marketPrices.historical,
                            borderColor: '#BFA69A',
                            backgroundColor: '#BFA69A33',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Prix Projet√©',
                            data: DEFAULT_DATA.marketPrices.projected,
                            borderColor: '#8C6A5D',
                            backgroundColor: '#8C6A5D33',
                            borderDash: [5, 5],
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCFA(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value / 1000 + 'k';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            resetAll();

            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('section');

            const observerOptions = {
                root: null,
                rootMargin: '0px',
                threshold: 0.3
            };

           // This is the fixed code
const observer = new IntersectionObserver((entries) => {
    // First, remove the 'active' class from ALL nav links
    navLinks.forEach(link => {
        link.classList.remove('active');
    });

    // Find the first entry that is currently intersecting
    const activeEntry = entries.find(entry => entry.isIntersecting);

    if (activeEntry) {
        // Find the matching link and add the 'active' class to it
        const activeLink = document.querySelector(`.nav-link[href="#${activeEntry.target.id}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    } else if (entries.length > 0) {
        // Optional: If nothing is intersecting (e.g., user is between sections),
        // default to the first link that passed the threshold.
        // This makes the highlighting feel "stickier".
        const firstEntry = entries[0];
        const firstLink = document.querySelector(`.nav-link[href="#${firstEntry.target.id}"]`);
        if (firstLink) {
             // This logic might need refinement based on scroll direction,
             // but for now, we'll just re-activate the 'default' one.
             // A simple solution is to just highlight the first link in the nav.
             navLinks[0].classList.add('active');
        }
    }

}, observerOptions);

sections.forEach(section => {
    observer.observe(section);
});
        });
        
    </script>
</body>
</html>


